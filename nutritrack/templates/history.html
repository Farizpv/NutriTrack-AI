{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Your Nutrition History</h2>

    {% if records %}
    <div class="table-responsive">
    <table class="table table-striped text-center align-middle">
        <thead>
            <tr>
                <th>Date</th>
                <th>Food</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for record in records %}
            {% if record.parsed_data %}
            <tr>
                <td>{{ record.timestamp.strftime("%Y-%m-%d %H:%M") }}</td>
                <td>{{ record.food_name }}</td>
                <td>
                    <div class="d-flex justify-content-center gap-2 flex-wrap">
                        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#details{{ record.id }}">Details</button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDelete({{ record.id }})">Delete</button>
                    </div>
                </td>
            </tr>

            <!-- Details Modal -->
            <div class="modal fade" id="details{{ record.id }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Nutrition Details - {{ record.food_name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            {% set data = record.parsed_data %}
                            <ul class="list-group mb-3">
                                <li class="list-group-item"><strong>Calories:</strong> {{ data.calories.value }} {{ data.calories.unit }}</li>
                                <li class="list-group-item"><strong>Protein:</strong> {{ data.protein.value }} {{ data.protein.unit }}</li>
                                <li class="list-group-item"><strong>Carbs:</strong> {{ data.carbohydrates.value }} {{ data.carbohydrates.unit }}</li>
                                <li class="list-group-item"><strong>Fats:</strong> {{ data.fats.value }} {{ data.fats.unit }}</li>
                                <li class="list-group-item"><strong>Sugars:</strong> {{ data.sugars.value }} {{ data.sugars.unit }}</li>
                                <li class="list-group-item"><strong>Fibre:</strong> {{ data.fibre.value }} {{ data.fibre.unit }}</li>
                            </ul>

                            {% if data.vitamins %}
                            <h6>Vitamins:</h6>
                            <ul>
                                {% for vitamin, val in data.vitamins.items() %}
                                <li>{{ vitamin }}: {{ val.value }} {{ val.unit }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            {% if data.minerals %}
                            <h6>Minerals:</h6>
                            <ul>
                                {% for mineral, val in data.minerals.items() %}
                                <li>{{ mineral }}: {{ val.value }} {{ val.unit }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}

                            {% if data.insight %}
                            <div class="alert alert-info mt-3">
                                <strong>Insight:</strong> {{ data.insight }}
                            </div>
                            {% endif %}

                            {% if data.notes %}
                            <div class="alert alert-secondary mt-2">
                                <em>Notes:</em> {{ data.notes }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="mt-4">No history found.</p>
    {% endif %}
</div>
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header text-bg-danger">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this item? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Deleted Successfully</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Entry has been deleted.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="location.reload()">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
let itemIdToDelete = null;
function confirmDelete(id) {
    itemIdToDelete = id;
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        if (itemIdToDelete) {
            fetch(`/delete-history/${itemIdToDelete}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'  // Helps distinguish AJAX calls
                },
                credentials: 'same-origin'  // Important for Flask-Login sessions
            })
            .then(res => {
                if (res.ok) {
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                } else {
                    alert("Failed to delete. Unauthorized or server issue.");
                }
            })
            .catch(() => alert("Error occurred while deleting."));
        }
    });
});

</script>
{% endblock %}
